# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

json-repair is a Go library and CLI tool for repairing malformed JSON strings, particularly those generated by LLMs. It handles various JSON anomalies like unclosed quotes, missing commas, invalid boolean values, and more.

## Architecture

### Core Components

- **jsonrepair.go**: Main library file containing the JSON parser and repair logic
  - `RepairJSON()`: Primary function that repairs JSON strings with error handling
  - `MustRepairJSON()`: Panic-recovering version for trusted environments
  - `JSONParser`: Stateful parser that processes malformed JSON through recursive descent

- **cli/jsonrepair-cli.go**: Command-line interface implementation
  - Supports `-i` for inline string input
  - Supports `-f` for file input
  - Includes `-h` help and `-v` version flags

### WebAssembly + Web Demo

- **wasm-build/main.go**: WASM entry with JS interop and detailed debug logs
  - Exposes two global JS functions after runtime init: `repairJSON(input)` and `mustRepairJSON(input)`
  - Imports the library package `github.com/RealAlexandreAI/json-repair`
- **wasm.go**: Minimal WASM entry variant (no extra logs)
- **build-wasm.sh**: One-click build script to produce `jsonrepair.wasm` and copy `wasm_exec.js` if missing
- **web/**: Static demo site
  - `index.html`: UI (includes buttons: 解析转义序列/去转义/高级去转义/Repair JSON/Must Repair JSON)
  - `app.js`: Loads `jsonrepair.wasm`, waits for `repairJSON`/`mustRepairJSON`, wires UI
  - `wasm_exec.js`: Go’s WASM runtime (copied by script)
  - `jsonrepair.wasm`: Build output (ignored in git, generated by script)

### Parser Design

The `JSONParser` uses a recursive descent approach with markers to track parsing context:
- **State management**: Uses `marker` slice to track parsing context (object_key, object_value, array)
- **Tokenization**: Processes JSON through methods like `parseObject()`, `parseArray()`, `parseString()`, `parseNumber()`
- **Error recovery**: Handles malformed JSON by making intelligent assumptions about structure

## Development Commands

### Testing
```bash
# Run all tests
go test ./...

# Run specific test
go test -v ./jsonrepair_test.go

# Run CLI tests
go test -v ./cli/jsonrepair-cli_test.go

# Run single test case
go test -run Test_RepairJSON/CASE-1 -v
```

### Building
```bash
# Build CLI
go build -o jsonrepair ./cli/jsonrepair-cli.go

# Install CLI globally
go install ./cli/jsonrepair-cli.go
```

### Build WebAssembly (WASM) and run Web Demo
```bash
# One-click build to produce jsonrepair.wasm and ensure wasm_exec.js exists
bash build-wasm.sh

# Open the demo
# Option A: Open web/index.html directly in a browser (may be limited by browser file:// policy)
# Option B: Serve via HTTP
cd web && python3 -m http.server 8080
# Then open http://localhost:8080
```

JS interop surface (available after the Go WASM runtime is running):
- `repairJSON(input: string): { result: string, error: string|null }`
- `mustRepairJSON(input: string): { result: string, error: string|null }`

### Using as Library
```bash
# Add to project
go get github.com/RealAlexandreAI/json-repair
```

## Code Patterns

### Adding New Test Cases
Tests use table-driven approach in `jsonrepair_test.go`. Each test case includes:
- `in`: Malformed JSON input
- `want`: Expected repaired JSON output
- Tests use `jsonStringsEqual()` for semantic comparison

### Parser Extension Points
- Add new parsing methods to `JSONParser` for additional JSON types
- Use `setMarker()` and `resetMarker()` for context tracking
- Implement recovery logic in individual parse methods

### CLI Usage Examples
```bash
# Repair inline JSON
jsonrepair -i "{'key': 'value', 'invalid': true}"

# Repair from file
jsonrepair -f broken.json

# Check version
jsonrepair -v
```

## Key Files

- `jsonrepair.go`: Core repair logic (700+ lines)
- `jsonrepair_test.go`: Comprehensive test suite
- `cli/jsonrepair-cli.go`: CLI implementation
- `go.mod`: Module definition (requires Go 1.21+)
- `wasm-build/main.go`: WASM entry with logs and JS bindings
- `wasm.go`: Minimal WASM entry with JS bindings
- `build-wasm.sh`: Build helper for WASM + web runtime
- `web/index.html`, `web/app.js`: Web demo UI and loader

## Dependencies

Zero external dependencies - uses only standard library packages:
- `encoding/json`
- `bytes`, `strings`, `strconv`, `unicode`
- `flag`, `fmt`, `os` (for CLI)

## Notes for Contributors

- Prefer updating both `wasm-build/main.go` and `wasm.go` when changing exported JS function shapes
- Keep `build-wasm.sh` idempotent and fast; avoid heavy tooling
- The web demo uses simple `fetch('./jsonrepair.wasm')`; serving via HTTP is recommended during development